{% extends "base.html" %}

{% block content %}
<div class="container-fluid animate-in p-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h2 class="display-5 fw-bold text-dark">Dashboard</h2>
            <p class="text-muted">Track your progress and follow your path to recovery.</p>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-warning rounded-pill me-2" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                <i class="fas fa-star me-2"></i>Rate Us
            </button>
            <a href="/encyclopedia" class="btn btn-outline-primary rounded-pill me-2">
                <i class="fas fa-book-medical me-2"></i>Find Diseases
            </a>
            <a href="/profile" class="btn btn-outline-secondary rounded-pill me-2">
                <i class="fas fa-user-circle me-2"></i>My Profile
            </a>
            <a href="/assess" class="btn btn-primary rounded-pill shadow-sm">
                <i class="fas fa-plus me-2"></i>New Checkup
            </a>
        </div>
    </div>

    {% if recovery and recovery.insight %}
    <div class="card mb-4 border-start border-5 border-info bg-light shadow-sm">
        <div class="card-body d-flex align-items-center">
            <div class="me-4 text-info"><i class="fas fa-brain fa-3x"></i></div>
            <div>
                <h5 class="text-info mb-1 fw-bold">AI Root Cause Analysis</h5>
                <p class="mb-0 lead text-dark">{{ recovery.insight }}</p>
                <small class="text-muted">Insight based on your Sleep, Stress, and BMI patterns.</small>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card text-center p-4 h-100 shadow-sm border-0">
                <i class="fas fa-heartbeat fa-2x text-primary mb-3"></i>
                <h6 class="text-muted text-uppercase fw-bold">Health Score</h6>
                <h1 class="display-3 fw-bold text-primary">{{ avg_score|round|int }}</h1>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center p-4 h-100 shadow-sm border-0">
                <i class="fas fa-clipboard-check fa-2x text-success mb-3"></i>
                <h6 class="text-muted text-uppercase fw-bold">Assessments</h6>
                <h1 class="display-3 fw-bold text-dark">{{ total_assessments }}</h1>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-4 h-100 border-0 shadow-sm d-flex flex-row align-items-center justify-content-between"
                style="background: {{ '#ffe5e5' if last_risk == 'High Risk' else '#e3fcec' }};">
                <div>
                    <h6 class="text-muted text-uppercase fw-bold">Current Status</h6>
                    <h2 class="mb-0 {{ 'text-danger' if last_risk == 'High Risk' else 'text-success' }}">
                        {{ last_risk or 'No Data' }}
                    </h2>
                </div>
                <i class="fas {{ 'fa-exclamation-circle text-danger' if last_risk == 'High Risk' else 'fa-check-circle text-success' }} fa-5x opacity-25"></i>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white pt-4 pb-0 border-0 d-flex justify-content-between">
                    <h4 class="mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>Health Trend</h4>
                    <span class="badge bg-light text-dark border">Last 10 Checkups</span>
                </div>
                <div class="card-body">
                    <div style="height: 400px; width: 100%;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if recovery %}
    <div class="card mb-5 border-0 shadow-lg bg-gradient-primary text-white" style="background: linear-gradient(45deg, #4e73df, #224abe);">
        <div class="card-body p-5">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3 class="fw-bold mb-2"><i class="fas fa-leaf me-2"></i>Recommended Path</h3>
                    <p class="lead mb-3">Focus Area: <strong>{{ recovery.issue }}</strong></p>
                    <div class="d-flex gap-3">
                        <button class="btn btn-light text-primary rounded-pill shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#yogaHero">
                            <i class="fas fa-om me-2"></i>Yoga Plan
                        </button>
                        <button class="btn btn-light text-danger rounded-pill shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#dietHero">
                            <i class="fas fa-apple-alt me-2"></i>Diet Plan
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-center d-none d-md-block">
                    <i class="fas fa-spa fa-6x opacity-25"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="collapse mb-5" id="yogaHero">
        <div class="card card-body shadow-sm border-0">
            <h5 class="text-primary">Yoga Routine</h5>
            <ul>
                {% for item in recovery.yoga %}
                <li class="mb-2">{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="collapse mb-5" id="dietHero">
        <div class="card card-body shadow-sm border-0">
            <h5 class="text-danger">Dietary Guidelines</h5>
            <ul>
                {% for item in recovery.diet %}
                <li class="mb-2">{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('trendChart');
        if (ctx) {
            // FIXED: Proper Jinja2 Syntax for variables
            const dates = {{ dates | tojson | safe }};
            const scores = {{ scores | tojson | safe }};

            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: dates.length ? dates : ['No Data'],
                    datasets: [{
                        label: 'Health Score',
                        data: scores.length ? scores : [0],
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#4e73df',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }
    });
</script>

<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rate Experience</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/submit-feedback" method="POST">
                <div class="modal-body">
                    <label class="form-label">Rating</label>
                    <select name="rating" class="form-select mb-3">
                        <option value="5">5 - Excellent</option>
                        <option value="4">4 - Very Good</option>
                        <option value="3">3 - Good</option>
                        <option value="2">2 - Fair</option>
                        <option value="1">1 - Poor</option>
                    </select>
                    <label class="form-label">Comment</label>
                    <textarea name="comment" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}